#define _GNU_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <sched.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdarg.h>
#include <linux/sched.h>

void write_to_file(const char *which, const char *format, ...) {
  FILE * fu = fopen(which, "w");
  va_list args;
  va_start(args, format);
  if (vfprintf(fu, format, args) < 0) {
    perror("cannot write");
    exit(1);
  }
  fclose(fu);
}

void init_cpu(void){
    cpu_set_t set;
    CPU_ZERO(&set);
    CPU_SET(0, &set);
    if (sched_setaffinity(getpid(), sizeof(set), &set) < 0) {
        perror("[-] sched_setaffinity");
		exit(EXIT_FAILURE);	
    }

}

void init_namespace(void) {
	uid_t uid = getuid();
	gid_t gid = getgid();	

    if (unshare(CLONE_NEWUSER) < 0) {
        perror("[-] unshare(CLONE_NEWUSER)");
		exit(EXIT_FAILURE);	
    }
    if (unshare(CLONE_NEWNET) < 0) {
        perror("[-] unshare(CLONE_NEWNET)");
		exit(EXIT_FAILURE);	
    }

	write_to_file("/proc/self/uid_map", "0 %d 1", uid);
    write_to_file("/proc/self/setgroups", "deny");
    write_to_file("/proc/self/gid_map", "0 %d 1", gid);

}

int main(void){
    init_cpu();
    init_namespace();

    system("/bin/sh");

    return 0;
}
